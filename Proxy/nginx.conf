events {
    worker_connections 1024;
}

http {
    # UPSTREAM DEFINITIONS (Internal Services)
    
    # Frontend (Vite dev server)
    upstream frontend {
        server front:3000;
    }

    # Login Service - HTTP API (port 5001)
    upstream login_api {
        server login:5001;
    }

    # Chat Service - HTTP API + WebSocket (port 5002)
    upstream chat_service {
        server chat:5002;
    }

    # Users Service - HTTP API (port 3003)
    upstream users_api {
        server users:3003;
    }

    # Notifications Service - HTTP API (port 3001)
    upstream notifications_api {
        server notifications:3001;
    }

    # Notifications Service - WebSocket (port 3002)
    upstream notifications_ws {
        server notifications:3002;
    }

    # Matches Service - HTTP API (port 3004)
    upstream matches_api {
        server matches:3004;
    }

    # Matches Service - WebSocket (port 3005)
    upstream matches_ws {
        server matches:3005;
    }

    # Game Service - HTTP API (port 5005)
    upstream game_api {
        server game:5005;
    }

    # Game Service - WebSocket (port 5006)
    upstream game_ws {
        server game:5006;
    }

    # HTTPS SERVER
    server {
        listen 443 ssl;
        server_name localhost;

        # SSL Certificates
        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;

        # SSL Settings (modern configuration)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # LOGIN SERVICE (:5001)
        location /register {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /login {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /logout {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /verify2FA {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /findUser/ {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /auth/google {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /me {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /2FA {
            proxy_pass http://login_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # CHAT SERVICE (:5002) - HTTP + WebSocket
        # Frontend uses: /friends/*, /LastMsg, socket.io
        location /friends/ {
            proxy_pass http://chat_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /LastMsg {
            proxy_pass http://chat_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Chat WebSocket (socket.io on :5002)
        location /socket.io/chat/ {
            rewrite ^/socket.io/chat/(.*) /socket.io/$1 break;
            proxy_pass http://chat_service;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }

        # USERS SERVICE (:3003)
        # Frontend uses: /profile/*, /experience, /uploads/*
        location /profile {
            proxy_pass http://users_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /experience {
            proxy_pass http://users_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /uploads/ {
            proxy_pass http://users_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # NOTIFICATIONS SERVICE (:3001 HTTP, :3002 WS)
        # Frontend uses: /notifications/*
        location /notifications {
            proxy_pass http://notifications_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notifications WebSocket (socket.io on :3002)
        location /socket.io/notifications/ {
            rewrite ^/socket.io/notifications/(.*) /socket.io/$1 break;
            proxy_pass http://notifications_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }

        # MATCHES SERVICE (:3004 HTTP, :3005 WS)
        # Frontend uses: /matches/*, /lobbies/*
        location /matches {
            proxy_pass http://matches_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /lobbies/ {
            proxy_pass http://matches_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Matches WebSocket (socket.io on :3005)
        location /socket.io/matches/ {
            rewrite ^/socket.io/matches/(.*) /socket.io/$1 break;
            proxy_pass http://matches_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }

        # GAME SERVICE (:5005 HTTP, :5006 WS)
        # Frontend uses: /juego-de-mierda namespace
        
        # Game WebSocket (socket.io on :5006, namespace /juego-de-mierda)
        location /socket.io/game/ {
            rewrite ^/socket.io/game/(.*) /socket.io/$1 break;
            proxy_pass http://game_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }

        # Game namespace direct access
        location /juego-de-mierda {
            proxy_pass http://game_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }

        # ============================================
        # VITE HMR (Hot Module Replacement) WebSocket
        # ============================================
        location /@vite/client {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        location /__vite_ping {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /ws {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_read_timeout 86400;
        }

        # FRONTEND (Default - Vite dev server)
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # HTTP to HTTPS Redirect
    server {
        listen 80;
        server_name localhost;
        return 301 https://$host$request_uri;
    }
}
